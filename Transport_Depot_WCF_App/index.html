<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title></title>
  <style type="text/css">
    body { font-size:small; }
    table { border-collapse: collapse; }
    table tr td 
    { 
      border: solid 1px #ccc; 
      padding: .2em;
    }
    .right {
      text-align: right;
    }
    .even { background-color:#ddd; }
  </style>
</head>
<body ng-app="apexUpload">
  <form ng-controller="uploader">
    <input type='file' 
           onchange="angular.element(this).scope().fileChanged(this)"  />
    <button ng-click="upload()" >Upload</button>
    <br />
    <div>
      <span>{{file.name}}</span><br />
      <span>{{path}}</span>
    </div>
    <table>
      
      <tr>
       <td>Exclude</td>
        <!-- Invoice -->
        <td>Invoice</td>
        <!-- Check -->
        <td>Check</td>
        <!-- Client -->
        <td>Client</td>
        <!-- Effective Date -->
        <td>Effective</td>
        <!-- Invoice Amount-->
        <td>Amount</td>
      </tr>
      <tr ng-repeat="payment in payments" ng-class-even="'even'">
       <td><input type="checkbox" ng-model="payment.exclude" /></td>
        <!-- Invoice -->
        <td>{{payment.InvoiceNumber}}</td>
        <!-- Check -->
        <td>{{payment.CheckNumber}}</td>
        <!-- Client -->
        <td>{{payment.Debtor}}</td>
        <!-- Effective Date -->
        <td>{{payment.EffectiveDate | date:'MM/dd/yyyy'}}</td>
        <!-- Invoice Amount-->
        <td class='right'>{{payment.Amount | currency }}</td>
      </tr>
    </table> 
    
  </form>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>  
  <script>
    function parseWcfDate(wcfDate){
        var d=wcfDate.match(/(\d+)/)[1];
        return new Date(+d);
    }
    angular.module('apexUpload', [])
      .controller('uploader', ['$scope', '$http',
        function ($scope, $http) {
          $scope.payments = [];
          
          $scope.fileChanged = function (elem) {
            $scope.path = elem.value;
            $scope.file = elem.files[0];
            $scope.$apply();
          };

          $scope.render = function (data) {
            $scope.payments = data;
          }

          $scope.upload = function () {
            var uri = 'Apex.svc/read?paymentsCsv=' + $scope.file.name;
            //var uri = 'Utilities.svc/ReadCsv?fileName=' + $scope.file.name;
            //var uri = 'http://localhost:4055/Apex.svc?apexCsv=' + $scope.file.name;
            $http.post(uri, $scope.file, {
              headers: { 'Content-Type': 'multipart/form-data' }
            })
            .success(function (d) {
              var json = d.ReadCsvResult;
              
              
              angular.forEach(json, function(value, key) {
                value.exclude = false;
                value.EffectiveDate = parseWcfDate(value.EffectiveDate);
              });
              $scope.render(json);
            })
            .error(function (data, status, headers, config) {
              debugger;
            });
          };
        }
      ]);
  </script>
</body>
</html>